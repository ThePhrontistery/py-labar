{% extends 'base.html' %} {% block content %}
<div class="bordered padding-top">
  <h1 class="text-2xl">Crear Grupo</h1>
  <form method="post" action="{{ url_for('create_group') }}">
    <fieldset>
      <legend>Detalles del Grupo</legend>
      <div class="my-4">
        <label for="name">Nombre del Grupo:</label>
        <input
          type="text"
          name="name"
          id="name"
          required
          class="w-full p-2 border rounded"
        />
      </div>
      <div class="my-4">
        <label>Seleccionar Usuarios:</label>
        <div class="overflow-auto max-h-40 border p-2 rounded">
          <ul class="list-none p-0 m-0">
            {% for user in all_users %}
              <li class="flex items-center space-x-2">
                <label class="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    name="selected_users"
                    value="{{ user.username }}"
                    class="form-checkbox"
                    hx-post="/groups/update_users" 
                    hx-trigger="change"
                  />
                  <span>{{ user.username }}</span>
                </label>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      <div class="my-4">
        <label for="users">Usuarios (separados por comas):</label>
        <input
          type="text"
          name="users"
          id="users"
          class="w-full p-2 border rounded"
          hx-post="/groups/update_users"
          hx-trigger="change"
          hx-target="#users-list"
          readonly
        />
      </div>
    </fieldset>
    <nav class="flex items-center justify-center gap-4">
      <a
      href="{{ url_for('return_home') }}"
      class="btn btn-sm bg-blue-500 text-white border-0 mx-auto"
      >Volver</a>
      <button
        type="submit"
        class="btn btn-sm bg-blue-500 text-white border-0 mx-auto"
      >
        Crear Grupo
      </button>
    </div>
    </nav>
  </form>
</div>

<style>
  .padding-top {
    padding-top: 80px;
  }
</style>

<script>
  document.addEventListener('htmx:afterSwap', function (event) {
    const xhr = event.detail.xhr;
    const updateUsersUrl = "/groups/update_users"; 

    if (xhr && xhr.responseURL && xhr.responseURL.endsWith(updateUsersUrl)) {

      const selectedCheckboxes = document.querySelectorAll('input[name="selected_users"]');
      const usersInput = document.getElementById('users');

      selectedCheckboxes.forEach((checkbox, index) => {
        checkbox.setAttribute('data-index', index);
      });

      const selectedUsers = Array.from(selectedCheckboxes)
        .filter((checkbox) => checkbox.checked)
        .sort((a, b) => a.getAttribute('data-index') - b.getAttribute('data-index'))
        .map((checkbox) => checkbox.value)
        .join(', ');

      usersInput.value = selectedUsers;

      console.log('Usuarios seleccionados:', selectedUsers);
    }
  });
</script>
{% endblock %}
